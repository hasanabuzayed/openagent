---
description: Environment variables and secrets handling
alwaysApply: true
---

# Secrets & Environment Variables

## Rules for Agents

- **Never paste secret values** into code, comments, docs, READMEs, or chat
- Read secrets from **environment variables** at runtime
- Use `secrets.json` (gitignored) as **local developer convenience**
- When adding new secrets, **update this file** and `secrets.json`

## secrets.json (root)

Template file for local credentials. Copy to `secrets.json` and fill in values.
**Never commit actual values.**

## Required Environment Variables

### Backend (Required)

| Variable | Description |
|----------|-------------|
| `OPENROUTER_API_KEY` | OpenRouter API key (sk-or-v1-...) |

### Backend (Production Auth)

| Variable | Description |
|----------|-------------|
| `DEV_MODE` | `true` bypasses auth; `false` requires JWT |
| `DASHBOARD_PASSWORD` | Password for dashboard login |
| `JWT_SECRET` | HMAC secret for JWT signing |
| `JWT_TTL_DAYS` | JWT validity (default: 30) |

### Memory/Storage (Optional)

| Variable | Description |
|----------|-------------|
| `SUPABASE_URL` | Supabase project URL |
| `SUPABASE_SERVICE_ROLE_KEY` | Service role key |
| `MEMORY_EMBED_MODEL` | Default: `openai/text-embedding-3-small` |
| `MEMORY_RERANK_MODEL` | Optional reranker |

**Supabase Storage Setup:**
The `upload_image` tool requires a public storage bucket named `images`:
1. Go to Supabase Dashboard â†’ Storage
2. Create a new bucket named `images`
3. Set it to **Public** (so image URLs are accessible without auth)

### SSH Console (Optional)

| Variable | Description |
|----------|-------------|
| `CONSOLE_SSH_HOST` | SSH target host |
| `CONSOLE_SSH_PORT` | SSH port (default: 22) |
| `CONSOLE_SSH_USER` | SSH user (default: root) |
| `CONSOLE_SSH_PRIVATE_KEY_PATH` | Path to private key (recommended) |
| `CONSOLE_SSH_PRIVATE_KEY_B64` | Base64 private key (alternative) |

### Web Search (Optional)

| Variable | Description |
|----------|-------------|
| `TAVILY_API_KEY` | Tavily search API key (tvly-...) |

### Agent Config (Optional)

| Variable | Default | Description |
|----------|---------|-------------|
| `DEFAULT_MODEL` | `google/gemini-3-flash-preview` | Default LLM (prefer gemini/qwen, never Claude) |
| `WORKING_DIR` | `/root` (prod), `.` (dev) | Working directory |
| `HOST` | `127.0.0.1` | Bind address |
| `PORT` | `3000` | Server port |
| `MAX_ITERATIONS` | `50` | Max agent loop iterations |
| `STALE_MISSION_HOURS` | `24` | Hours of inactivity before auto-closing missions (0=disabled) |

### Context Injection (Optional)

Controls how much context is injected into agent prompts to prevent token overflow.

| Variable | Default | Description |
|----------|---------|-------------|
| `CONTEXT_MAX_HISTORY_MESSAGES` | `10` | Conversation messages to keep |
| `CONTEXT_MAX_MESSAGE_CHARS` | `5000` | Max chars per message |
| `CONTEXT_MAX_HISTORY_CHARS` | `30000` | Total history context cap |
| `CONTEXT_MEMORY_CHUNK_LIMIT` | `3` | Past task chunks to retrieve |
| `CONTEXT_MEMORY_THRESHOLD` | `0.6` | Chunk similarity threshold |
| `CONTEXT_USER_FACTS_LIMIT` | `10` | User facts to inject |
| `CONTEXT_MISSION_SUMMARIES_LIMIT` | `5` | Mission summaries to inject |
| `CONTEXT_MAX_TOOL_RESULT_CHARS` | `15000` | Tool result truncation limit |

### Desktop Automation (Optional)

| Variable | Default | Description |
|----------|---------|-------------|
| `DESKTOP_ENABLED` | `false` | Enable desktop_* tools (Xvfb, xdotool, etc.) |
| `DESKTOP_RESOLUTION` | `1920x1080` | Virtual display resolution |
| `DESKTOP_DISPLAY_START` | `99` | Starting X display number |

### Dashboard

| Variable | Description |
|----------|-------------|
| `NEXT_PUBLIC_API_URL` | Backend API URL |

## File Locations

| Environment | Backend Env | Dashboard Env |
|-------------|-------------|---------------|
| Local | `.env` | `dashboard/.env.local` |
| Production | `/etc/open_agent/open_agent.env` | Vercel env vars |

## jq Examples (reading secrets.json)

```bash
# Get OpenRouter key
jq -r '.openrouter.api_key' secrets.json

# Get Supabase URL
jq -r '.supabase.url' secrets.json

# List all keys
jq 'keys' secrets.json
```
