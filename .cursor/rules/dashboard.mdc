---
description: Dashboard (Next.js + Bun) conventions
globs: ["dashboard/**"]
---

# Dashboard Conventions

## Package Manager: Bun (not npm/yarn/pnpm)

```bash
cd dashboard
bun install          # install deps
bun dev              # dev server on :3001
bun run build        # production build
bun add <package>    # add dependency (gets latest version)
```

## Stack

| Tech | Version | Purpose |
|------|---------|---------|
| Next.js | 16.x | React framework |
| React | 19.x | UI library |
| Tailwind | 4.x | Styling |
| Bun | 1.3+ | Package manager + runtime |
| xterm | 5.x | Terminal emulator |

## API Communication

```typescript
// All API calls go through lib/api.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL ?? 'http://127.0.0.1:3000';

// Auth: JWT stored in sessionStorage
const token = sessionStorage.getItem('jwt');
headers: { 'Authorization': `Bearer ${token}` }

// SSE streaming (uses fetch, not EventSource, for auth headers)
```

## Directory Structure

```
dashboard/src/
├── app/              # Next.js App Router pages
│   ├── control/      # Mission control panel (chat interface)
│   ├── history/      # Agents page - mission history + tree modal
│   ├── console/      # SSH terminal + file explorer
│   ├── modules/      # MCP module management
│   ├── files/        # File explorer
│   └── settings/     # Configuration
├── components/
│   ├── ui/           # Generic UI components
│   ├── tool-ui/      # Tool-specific UI (option-list, data-table)
│   └── agent-tree/   # Agent tree visualization components
├── hooks/            # React hooks
└── lib/              # Utilities (api, auth, settings)
```

## Navigation Structure

| Nav Item | Route | Description |
|----------|-------|-------------|
| Overview | `/` | Global stats and recent missions |
| Mission | `/control` | Active mission chat interface |
| Agents | `/history` | Mission history with tree visualization modal |
| Console | `/console` | SSH terminal access |
| Modules | `/modules` | MCP server management |
| Settings | `/settings` | Configuration |

## Refresh Resilience Pattern

The dashboard maintains state snapshots on the backend so users can refresh or navigate away without losing visual state.

### Server-Side Snapshots

```typescript
// API endpoints for fetching current state
GET /api/control/tree     → AgentTreeNode | null  // Current tree snapshot
GET /api/control/progress → ExecutionProgress     // Current progress (subtask X/Y)
```

### Frontend Pattern

1. **On mount**: Fetch snapshot first, then subscribe to SSE
2. **On SSE event**: Update state in real-time
3. **On idle status**: Clear state

```tsx
useEffect(() => {
  // 1. Fetch initial snapshot for refresh resilience
  getAgentTree().then(setTree);
  getProgress().then(setProgress);
  
  // 2. Subscribe to live updates
  const cleanup = streamControl((event) => {
    if (event.type === 'agent_tree') setTree(event.data.tree);
    if (event.type === 'progress') setProgress(event.data);
    if (event.type === 'status' && event.data.state === 'idle') {
      setTree(null);
      setProgress(null);
    }
  });
  
  return cleanup;
}, []);
```

## Agent Tree Visualization

Dynamic, animated tree visualization for hierarchical agent execution. Uses SVG + framer-motion for smooth animations. 

The tree is accessed via a **modal** from the Agents page (formerly History):
- Click the tree icon on any mission row to open the full-screen modal
- Modal shows the agent execution tree with pan/zoom controls

### Component Structure

```
components/agent-tree/
├── index.ts              # Public exports
├── types.ts              # Type definitions (AgentNode, LayoutNode, etc.)
├── layout.ts             # Tree layout algorithm (modified Reingold-Tilford)
├── demo-data.ts          # Demo tree generators for testing
└── AgentTreeCanvas.tsx   # Main visualization component
```

### Usage

```tsx
import { 
  AgentTreeCanvas, 
  type AgentNode 
} from '@/components/agent-tree';

// Full mode (in Control page panel)
<AgentTreeCanvas 
  tree={agentTree} 
  selectedNodeId={selectedId}
  onSelectNode={(node) => setSelectedId(node?.id ?? null)} 
/>

// Compact mode (in History page preview, side panels)
<AgentTreeCanvas tree={agentTree} compact className="w-full h-full" />
```

### Props

| Prop | Type | Description |
|------|------|-------------|
| `tree` | `AgentNode \| null` | Tree data to visualize |
| `onSelectNode` | `(node: AgentNode \| null) => void` | Node selection callback |
| `selectedNodeId` | `string \| null` | Currently selected node ID |
| `compact` | `boolean` | Compact mode - hides minimap and details panel |
| `className` | `string` | Additional CSS classes |

### Node Display

Each node shows:
- **Icon**: Agent type (Bot, Brain, Cpu, Zap, Target, GitBranch)
- **Name**: Truncated agent name
- **Model**: LLM model used (e.g., `gemini-3-flash`)
- **Status**: Running (pulse), Completed (✓), Failed (✗), Pending (clock)
- **Budget**: Spent / Allocated (e.g., `$0.35 / $9.00`)

### Interactions

- **Pan**: Click and drag to move the tree
- **Zoom**: Mouse wheel or +/- buttons
- **Select**: Click a node to show details panel (full mode only)
- **Fit**: Reset view button fits tree to viewport

## Environment Variables

Dashboard uses `.env.local`:
```
NEXT_PUBLIC_API_URL=http://127.0.0.1:3000
```

## Auth Flow

1. Dashboard checks `/api/health` for `auth_required`
2. If required, prompts password → `POST /api/auth/login`
3. Stores JWT + expiry in `sessionStorage`
4. Sends `Authorization: Bearer <jwt>` on all requests
5. WebSocket auth: uses subprotocol `["openagent", "jwt.<token>"]`

## Icons

Use Lucide React (`lucide-react`), not Remix Icons:
```tsx
import { Home, Settings, Play } from 'lucide-react';
<Home className="h-4 w-4" />
```

## Ports

| Service | Port |
|---------|------|
| Backend API | 3000 |
| Dashboard | 3001 |
